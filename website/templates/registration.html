<!DOCTYPE html>

<html lang="en">

<head>
    <title>Cryptography - Project</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="/static/css/registration.css">
    <link rel="stylesheet" type="text/css" href="/static/css/styles.css">
    <link rel="icon" type="image/ico" href="/static/img/favicon.ico">

    {% if message_type == 'success' %}
    <meta http-equiv="refresh" content="1.5; url=/login">
    {% endif %}
</head>

<body>
    <div class="back-button">
        <a href="/">
            <button type="submit" class="button back-button-style">Back</button>
        </a>
    </div>


    <div class="header">
        <h1>Registration!</h1>
        <h2>This website is protected with HTTPS using a custom PKI</h2>
        <hr>
    </div>


    <div class="form-container">
        <div class="form-block">
            <form action="/registration" method="POST">
                <table>
                    <tbody>
                        <tr>
                            <td><label>Username</label></td>
                            <td>
                                <input type="text" placeholder="Enter Username" name="username" maxlength="32"
                                    class="{% if message_type == 'error' %}input-error{% elif message_type == 'success' %}input-success{% endif %}"
                                    autocomplete="off" oninvalid="this.setCustomValidity('Username is required!')"
                                    oninput="this.setCustomValidity('')" required>
                            </td>
                        </tr>

                        <tr>
                            <td><label>Password</label></td>
                            <td>
                                <input type="password" placeholder="Enter Password" name="password"
                                    class="{% if message_type == 'error' %}input-error{% elif message_type == 'success' %}input-success{% endif %}"
                                    autocomplete="off" oninvalid="this.setCustomValidity('Password is required!')"
                                    oninput="this.setCustomValidity('')" required>
                                <div id="passwordHelp">
                                </div>
                            </td>
                        </tr>

                        <tr>
                            <td colspan="2" class="message-cell">
                                {% if message %}
                                <div class="message {{ message_type }}">
                                    {{ message }}
                                </div>
                                {% else %}
                                <div class="message-placeholder"></div>
                                {% endif %}
                            </td>
                        </tr>

                        <tr>
                            <td colspan="2" style="text-align: right;">
                                <button type="submit" class="button-register">Register</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </form>
            
            {% if message2 %}
            <div class="message {{ message_type }}">
                {{ message2 }}
            </div>
            {% endif %}
        </div>
    </div>

    <script>
        // Real-time password validation
        const passwordInput = document.querySelector('input[name="password"]');
        const passwordHelp = document.getElementById('passwordHelp');
        const form = document.getElementById('registrationForm');

        passwordInput.addEventListener('input', function () {
            const password = passwordInput.value;

            // Clear validation message if password is empty
            if (password === "") {
                passwordHelp.innerHTML = "";
                return;
            }

            const rules = [
                { regex: /.{8,}/, message: "At least 8 characters" },
                { regex: /[A-Z]/, message: "One uppercase letter" },
                { regex: /[a-z]/, message: "One lowercase letter" },
                { regex: /[@$!%*?&]/, message: "One special character (@$!%*?&)" }
            ];

            const errors = rules.filter(rule => !rule.regex.test(password)).map(rule => rule.message);

            if (errors.length === 0) {
                passwordHelp.style.color = "green";
                passwordHelp.innerHTML = "Password is strong!";
            } else {
                passwordHelp.style.color = "red";
                passwordHelp.innerHTML = `
                    Your password must include:
                    <ul style="margin: 0; padding-left: 20px;">
                        ${errors.map(error => `<li>${error}</li>`).join("")}
                    </ul>
                `;
            }
        });

        // Form submit validation
        form.addEventListener('submit', function (event) {
            if (passwordInput.value === "" || passwordHelp.style.color === "red") {
                // Prevent form submission
                event.preventDefault();

                passwordInput.setCustomValidity("Password is required and must meet the strength criteria.");
                passwordInput.reportValidity();
            } else {
                passwordInput.setCustomValidity(""); 
            }
        });

        const inputs = document.querySelectorAll('input');
        inputs.forEach(input => {
            input.addEventListener('input', function () {
                input.classList.remove('input-error', 'input-success');
            });
        });

    </script>


</body>

</html>